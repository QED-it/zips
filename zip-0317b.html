<!DOCTYPE html>
<html>
<head>
    <title>ZIP 317b: ZSA Extension Proportional Fee Mechanism</title>
    <meta charset="utf-8" />
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js?config=TeX-AMS-MML_HTMLorMML"></script>
<meta name="viewport" content="width=device-width, initial-scale=1"><link rel="stylesheet" href="css/style.css"></head>
<body>
    <section>
        <pre>ZIP: 0317b
Title: ZSA Extension Proportional Fee Mechanism
Owners: Daniel Benarroch &lt;daniel@qed-it.com&gt;
        Pablo Kogan &lt;pablo@qed-it.com&gt;
        Jonathan Rouach &lt;jon@qed-it.com&gt;
Credits: Daira Hopwood
         Jack Grigg
         Aditya Bharadwaj
Status: Draft
Category: Standards / Wallet
Created: 2022-11-25
License: MIT
Discussions-To: &lt;&gt;</pre>
        <section id="terminology"><h2><span class="section-heading">Terminology</span><span class="section-anchor"> <a rel="bookmark" href="#terminology"><img width="24" height="24" class="section-anchor" src="assets/images/section-anchor.png" alt=""></a></span></h2>
            <p>The key words "SHOULD", "SHOULD NOT", and "RECOMMENDED" in this document are to be interpreted as described in RFC 2119. <a id="id1" class="footnote_reference" href="#rfc2119">1</a></p>
            <p>The term "conventional transaction fee" in this document is in reference to the value of a transaction fee that is conventionally used by wallets, and that a user can reasonably expect miners on the Zcash network to accept for including a transaction in a block.</p>
            <p>We define the following additional terms:</p>
            <ul>
                <li>The term "network upgrade" in this document is to be interpreted as described in ZIP 200 <a id="id2" class="footnote_reference" href="#zip-0200">2</a>.</li>
                <li>The term "Orchard" in this document is to be interpreted as described in ZIP 224 <a id="id3" class="footnote_reference" href="#zip-0224">3</a>.</li>
                <li>The term "ZSA" in this document is to be interpreted as described in ZIP 226 <a id="id4" class="footnote_reference" href="#zip-0226">4</a>.</li>
                <li>The term "Issuance" and "Issuance Action" in this document are to be interpreted as described in ZIP 227 <a id="id5" class="footnote_reference" href="#zip-0227">5</a>.</li>
                <li>The term "Proportional Fee" in this document is to be interpreted as described in ZIP 317 <a id="id6" class="footnote_reference" href="#zip-0317">6</a></li>
                <li>Issuance Fee: is the specific fixed fee that has to be paid to the network for every given issuance action</li>
            </ul>
        </section>
        <section id="abstract"><h2><span class="section-heading">Abstract</span><span class="section-anchor"> <a rel="bookmark" href="#abstract"><img width="24" height="24" class="section-anchor" src="assets/images/section-anchor.png" alt=""></a></span></h2>
            <p>This ZIP aims at defining explicitly the fee mechanism associated with the Zcash Shielded Assets protocol (ZSA) as described in ZIP 226 <a id="id7" class="footnote_reference" href="#zip-0226">4</a> and ZIP 227 <a id="id8" class="footnote_reference" href="#zip-0227">5</a>. We will be basing this ZIP as an extension of the latest fee-related ZIP, ZIP 317 <a id="id9" class="footnote_reference" href="#zip-0317">6</a>.</p>
        </section>
        <section id="motivation"><h2><span class="section-heading">Motivation</span><span class="section-anchor"> <a rel="bookmark" href="#motivation"><img width="24" height="24" class="section-anchor" src="assets/images/section-anchor.png" alt=""></a></span></h2>
            <p>As the Zcash blockchain moves towards the Proportional Transfer Fee Mechanism proposed ZIP 317 <a id="id10" class="footnote_reference" href="#zip-0317">6</a>, transactions that use the ZSA protocol must adapt to this mechanism and include fees consistent with ZIP 317 <a id="id11" class="footnote_reference" href="#zip-0317">6</a>.</p>
            <p>In this ZIP we propose an adaptation of ZIP 317 <a id="id12" class="footnote_reference" href="#zip-0317">6</a> as it applies to ZSA transfer transactions and explore ZSA-specific considerations such as fees for asset issuance.</p>
            <p>Specifically, the ZSA transfer and burn mechanism should follow the same fee mechanism in order to not discriminate between transfer bundle types. When it comes to Issuance of ZSA, however, we believe that there should be a preventative incentive that will stop users from flooding the chain with useless asset identifiers.</p>
            <p>There are two main factors that will affect the fee mechanism:</p>
            <ul>
                <li>The transaction size, which may take a big part of the block</li>
                <li>The computational power needed to verify and mine the transaction</li>
            </ul>
            <p>In the case of Issuance, the latter is not so relevant as the computational power needed to verify the bundle is not large. The transaction size, however, can be an issue as the number of output notes can be large. Furthermore, as defined in ZIP 227 <a id="id13" class="footnote_reference" href="#zip-0227">5</a>, there is a new struct in the global state that needs to be maintained as part of the consensus, which motivates further the addition of an Issuance-specific fee.</p>
        </section>
        <section id="requirements"><h2><span class="section-heading">Requirements</span><span class="section-anchor"> <a rel="bookmark" href="#requirements"><img width="24" height="24" class="section-anchor" src="assets/images/section-anchor.png" alt=""></a></span></h2>
            <ul>
                <li>The conventional fee formula should not favour or discriminate against any of the Orchard, Sapling, or transparent protocols.</li>
                <li>The fee for a transaction should scale linearly with the number of inputs and/or outputs.</li>
                <li>Users should be discouraged from creating new “garbage” custom assets</li>
                <li>Users should not be penalised for sending transactions constructed with padding of inputs and outputs to reduce information leakage. (The default policy employed by zcashd and the mobile SDKs pads to two inputs and two outputs for each shielded pool used by the transaction).</li>
                <li>Users should be able to spend a small number of UTXOs or notes with value below the marginal fee per input.</li>
            </ul>
        </section>
        <section id="specification"><h2><span class="section-heading">Specification</span><span class="section-anchor"> <a rel="bookmark" href="#specification"><img width="24" height="24" class="section-anchor" src="assets/images/section-anchor.png" alt=""></a></span></h2>
            <p>The specification of this ZIP is based on the Proportional Transfer Fee Mechanism ZIP 317 <a id="id14" class="footnote_reference" href="#zip-0317">6</a>. We expand on how this mechanism will be affected by the replacement of the ZSA protocol for the Orchard protocol.</p>
            <section id="issuance-action-fee"><h3><span class="section-heading">Issuance Action Fee</span><span class="section-anchor"> <a rel="bookmark" href="#issuance-action-fee"><img width="24" height="24" class="section-anchor" src="assets/images/section-anchor.png" alt=""></a></span></h3>
                <p>As reasoned above, we propose a fee for each issuance action, <cite>issuance_fee</cite>, in order to prevent users from issuing "garbage" assets and to incentivize miners to maintain a more complex blockchain state. The proposed fee mechanism is that for each new asset type (i.e.: for each issuance action), the issuer will pay a fixed fee for the action itself, of <cite>0.01 ZEC</cite> or <cite>1,000,000 ZATS</cite>, and a proportional fee for each output note generated for that asset (which is kept in line with the proportional fee mechanism from ZIP 317 <a id="id15" class="footnote_reference" href="#zip-0317">6</a>).</p>
            </section>
            <section id="zsa-fee-calculation"><h3><span class="section-heading">ZSA Fee calculation</span><span class="section-anchor"> <a rel="bookmark" href="#zsa-fee-calculation"><img width="24" height="24" class="section-anchor" src="assets/images/section-anchor.png" alt=""></a></span></h3>
                <p>The overall <cite>conventional_fee</cite> for a transaction is calculated as the sum of the <cite>issuance_fee</cite> and the <cite>transfer_fee</cite>: As in ZIP 317 <a id="id16" class="footnote_reference" href="#zip-0317">6</a>, this specification defines several parameters that are used to calculate the conventional fee:</p>
                <table>
                    <thead>
                        <tr>
                            <th>Parameter</th>
                            <th>Units</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>
                                <span class="math">\(marginal\_fee\)</span>
                            </td>
                            <td>zatoshis per logical action (as defined below)</td>
                        </tr>
                        <tr>
                            <td>
                                <span class="math">\(issusnce\_fee\)</span>
                            </td>
                            <td>zatoshis per issuance action (as defined below)</td>
                        </tr>
                        <tr>
                            <td>
                                <span class="math">\(grace\_actions\)</span>
                            </td>
                            <td>logical actions</td>
                        </tr>
                        <tr>
                            <td>
                                <span class="math">\(p2pkh\_standard\_input\_size\)</span>
                            </td>
                            <td>bytes</td>
                        </tr>
                        <tr>
                            <td>
                                <span class="math">\(p2pkh\_standard\_output\_size\)</span>
                            </td>
                            <td>bytes</td>
                        </tr>
                    </tbody>
                </table>
                <p>Wallets implementing this specification SHOULD use a conventional fee calculated in zatoshis per the following formula:</p>
                <div class="math">\(\begin{array}{rcl}
  logical\_actions  &amp;=&amp; \mathsf{max}\big(\mathsf{ceiling}\big(\frac{tx\_in\_total\_size}{p2pkh\_standard\_input\_size}\big),
                                         \mathsf{ceiling}\big(\frac{tx\_out\_total\_size}{p2pkh\_standard\_output\_size}\big)\big) \;+ \\
                    &amp; &amp; 2 \cdot nJoinSplit \;+ \\
                    &amp; &amp; \mathsf{max}(nSpendsSapling, nOutputsSapling) \;+ \\
                    &amp; &amp; nActionsZsaTransfer \;+ \\
                    &amp; &amp; nTotalOutputsZsaIssuance \\
  conventional\_fee &amp;=&amp; marginal\_fee \cdot \mathsf{max}(grace\_actions, logical\_actions) \;+ \\
                    &amp; &amp; issuance\_fee \cdot nActionsIssuance
\end{array}\)</div>
                <p>The inputs to this formula are taken from transaction fields defined in the Zcash protocol specification <a id="id17" class="problematic" href="#id19">[#protocol-txnencoding]_</a>:</p>
                <table>
                    <thead>
                        <tr>
                            <th>Input</th>
                            <th>Units</th>
                            <th>Description</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>
                                <span class="math">\(tx\_in\_total\_size\)</span>
                            </td>
                            <td>bytes</td>
                            <td>total size in bytes of the <code>tx_in</code> field</td>
                        </tr>
                        <tr>
                            <td>
                                <span class="math">\(tx\_out\_total\_size\)</span>
                            </td>
                            <td>bytes</td>
                            <td>total size in bytes of the <code>tx_out</code> field</td>
                        </tr>
                        <tr>
                            <td>
                                <span class="math">\(nJoinSplit\)</span>
                            </td>
                            <td>number</td>
                            <td>the number of Sprout JoinSplits</td>
                        </tr>
                        <tr>
                            <td>
                                <span class="math">\(nSpendsSapling\)</span>
                            </td>
                            <td>number</td>
                            <td>the number of Sapling spends</td>
                        </tr>
                        <tr>
                            <td>
                                <span class="math">\(nOutputsSapling\)</span>
                            </td>
                            <td>number</td>
                            <td>the number of Sapling outputs</td>
                        </tr>
                        <tr>
                            <td>
                                <span class="math">\(nActionsZsaTransfer\)</span>
                            </td>
                            <td>number</td>
                            <td>the number of ZSA transfer actions</td>
                        </tr>
                        <tr>
                            <td>
                                <span class="math">\(nTotalOutputsZsaIssuance\)</span>
                            </td>
                            <td>number</td>
                            <td>the total number of ZSA issuance outputs (added across issuance actions)</td>
                        </tr>
                        <tr>
                            <td>
                                <span class="math">\(nActionsZsaIssuance\)</span>
                            </td>
                            <td>number</td>
                            <td>the number of ZSA issuance actions</td>
                        </tr>
                    </tbody>
                </table>
                <p>The parameters are set to the following values:</p>
                <ul>
                    <li>
                        <span class="math">\(marginal\_fee = 5000\)</span>
                    ;</li>
                    <li>
                        <span class="math">\(issuance\_fee = 1000000\)</span>
                    ;</li>
                    <li>
                        <span class="math">\(grace\_actions = 2\)</span>
                    ;</li>
                    <li>
                        <span class="math">\(p2pkh\_standard\_input\_size = 150\)</span>
                     bytes;</li>
                    <li>
                        <span class="math">\(p2pkh\_standard\_output\_size = 34\)</span>
                     bytes.</li>
                </ul>
                <p>It is not a consensus requirement that fees follow this formula; however, wallets SHOULD create transactions that pay this fee, in order to reduce information leakage, unless overridden by the user.</p>
            </section>
        </section>
        <section id="other-considerations"><h2><span class="section-heading">Other Considerations</span><span class="section-anchor"> <a rel="bookmark" href="#other-considerations"><img width="24" height="24" class="section-anchor" src="assets/images/section-anchor.png" alt=""></a></span></h2>
            <div>
                <h1>System Message: WARNING/2 (zip-0317b.rst line 149)</h1>
                <p>Title underline too short.</p>
                <pre>Other Considerations
================</pre>
            </div>
            <p>We also briefly considered, and propose to reject, the opportunity for a new type of fee, denominated in the ZSA token itself. In the context of transparent transactions, this type of fee allows to “tap into” the value of the transactions for the benefit of the miners. However when transactions are shielded, any design that lifts value from the transaction would also leak information about it. Another consideration against ZSA-denominated fees is to maintain the ZEC as the primary token for the Zcash blockchain, similar to how ETH is needed for ERC20 transactions to the benefit of the Ethereum ecosystem.</p>
        </section>
        <section id="references"><h2><span class="section-heading">References</span><span class="section-anchor"> <a rel="bookmark" href="#references"><img width="24" height="24" class="section-anchor" src="assets/images/section-anchor.png" alt=""></a></span></h2>
            <table id="rfc2119" class="footnote">
                <tbody>
                    <tr>
                        <th>1</th>
                        <td><a href="https://www.rfc-editor.org/rfc/rfc2119.html">RFC 2119: Key words for use in RFCs to Indicate Requirement Levels</a></td>
                    </tr>
                </tbody>
            </table>
            <table id="zip-0200" class="footnote">
                <tbody>
                    <tr>
                        <th>2</th>
                        <td><a href="zip-0200.html">ZIP 200: Network Upgrade Mechanism</a></td>
                    </tr>
                </tbody>
            </table>
            <table id="zip-0224" class="footnote">
                <tbody>
                    <tr>
                        <th>3</th>
                        <td><a href="zip-0224.html">ZIP 224: Orchard</a></td>
                    </tr>
                </tbody>
            </table>
            <table id="zip-0226" class="footnote">
                <tbody>
                    <tr>
                        <th>4</th>
                        <td><a href="zip-0226.html">ZIP 226: Transfer and Burn of Zcash Shielded Assets</a></td>
                    </tr>
                </tbody>
            </table>
            <table id="zip-0227" class="footnote">
                <tbody>
                    <tr>
                        <th>5</th>
                        <td><a href="zip-0227.html">ZIP 227: Issuance of Zcash Shielded Assets</a></td>
                    </tr>
                </tbody>
            </table>
            <table id="zip-0317" class="footnote">
                <tbody>
                    <tr>
                        <th>6</th>
                        <td><a href="zip-0317.html">ZIP 317: Proportional Transfer Fee Mechanism</a></td>
                    </tr>
                </tbody>
            </table>
        </section>
    </section>
    <section class="system-messages">
        <h1>Docutils System Messages</h1>
        <div id="id18">
            <h1>System Message: ERROR/3 (zip-0317b.rst line 119)</h1>
            <p>Too many autonumbered footnote references: only 0 corresponding footnotes available.</p>
        </div>
        <div id="id19">
            <h1>System Message: ERROR/3 (zip-0317b.rst line 119) <a href="#id17">id17</a></h1>
            <p>Unknown target name: "protocol-txnencoding".</p>
        </div>
    </section>
</body>
</html>